{% extends "layout_dashboard.html" %}
{% block nav_title %}Bed & Staff Allocation{% endblock %}

{% block main_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm healflow-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-cogs me-2"></i>Smart Resource Optimization
                </h5>
                <p class="text-muted">AI-powered recommendations for optimal bed and staff allocation</p>
                <button class="btn btn-primary" onclick="optimizeAllocation()">
                    <i class="fas fa-magic me-2"></i>Auto Optimize
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm healflow-card">
            <div class="card-body">
                <h5 class="card-title">Department Bed Allocation</h5>
                <div class="table-responsive">
                    <table class="table table-hover healflow-table" id="allocationTable">
                        <thead class="table-primary">
                            <tr>
                                <th>Department</th>
                                <th>Total Beds</th>
                                <th>Occupied</th>
                                <th>Available</th>
                                <th>Utilization</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody id="allocationTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Click "Auto Optimize" to generate recommendations</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm healflow-card">
            <div class="card-body">
                <h5 class="card-title">Bed Utilization Rate</h5>
                <div class="healflow-chart-wrap"><div id="utilizationChart"></div></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function optimizeAllocation() {
    var tbody = document.getElementById('allocationTableBody');
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading…</td></tr>';

    fetch('/api/beds/allocate')
        .then(function(response) {
            if (!response.ok) throw new Error('Request failed: ' + response.status);
            return response.json();
        })
        .then(function(data) {
            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No allocation data available.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            var departments = [];
            var utilizations = [];
            data.forEach(function(dept) {
                var utilizationClass = dept.utilization > 85 ? 'text-danger' : dept.utilization > 70 ? 'text-warning' : 'text-success';
                var rec = (dept.recommendation != null && dept.recommendation !== '') ? dept.recommendation : '—';
                tbody.innerHTML += '<tr>' +
                    '<td><strong>' + (dept.department || '—') + '</strong></td>' +
                    '<td>' + (dept.total_beds != null ? dept.total_beds : '—') + '</td>' +
                    '<td>' + (dept.occupied_beds != null ? dept.occupied_beds : '—') + '</td>' +
                    '<td>' + (dept.available_beds != null ? dept.available_beds : '—') + '</td>' +
                    '<td><span class="' + utilizationClass + '">' + (dept.utilization != null ? dept.utilization : '—') + '%</span></td>' +
                    '<td>' + rec + '</td></tr>';
                departments.push(dept.department || '—');
                utilizations.push(typeof dept.utilization === 'number' ? dept.utilization : 0);
            });
            var chartEl = document.getElementById('utilizationChart');
            if (chartEl && typeof Plotly !== 'undefined') {
                var chartData = [{ x: departments, y: utilizations, type: 'bar', marker: { color: utilizations.map(function(u) { return u > 85 ? '#dc3545' : u > 70 ? '#ffc107' : '#198754'; }) } }];
                var layout = { yaxis: { title: 'Utilization (%)', range: [0, 100] }, title: 'Department Bed Utilization', height: 380, margin: { t: 50, r: 40, b: 80, l: 60 }, autosize: false };
                Plotly.newPlot('utilizationChart', chartData, layout, { responsive: true });
            }
        })
        .catch(function(err) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Could not load data. Try again.</td></tr>';
            console.error('Allocation error:', err);
        });
}
</script>
{% endblock %}
